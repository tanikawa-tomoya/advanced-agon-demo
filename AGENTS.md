本書は、新設計に基づくエージェント（直列ジョブの集合）の実装規約を定義します。対象は以下のディレクトリです。

js/page/**

js/service-app/**

js/service-boot/**

付随ルール：utils/utils.js

補足：既存の各種 Markdown ドキュメントには旧設計が含まれますが、本規約に従うため 旧設計は参照しません。

1. 基本方針（新設計の要点）

ESM 禁止

import / export、<script type="module">、Node の require() は使用しません。

すべて クラシックスクリプト 前提の構成とし、必要なシンボルは読み込み順や既存の準拠ファイルの方式に合わせて参照可能にします。

クラス実装

各ジョブは 1 ジョブ = 1 ファイル、1 クラスで実装します（job-*.js）。

直列実行のエントリポイントは main.js とし、ジョブの並びと実行のみを責務とします。

直列パイプライン

main.js がジョブ列を 順番に実行します。

非同期処理がある場合も、結果が順序に依存する限り直列で扱います。

カテゴリ分割の原則

「1 ジョブ = 1 ファイル」は厳守。

ジョブの分割・命名は サービスの機能やページの構成に即した「開発しやすいカテゴライズ」に従います。

恣意的・過細分化や、逆に肥大化した巨大ジョブは避けます。

既存準拠ファイルに倣うこと

規約に沿った実装を行っている既存ファイルに記述がないコードの書き方・構成は 禁止します（新規の独自流儀を持ち込まない）。

不明点がある場合は、既存の準拠ファイルと同一の方針に合わせます。

2. 用語

エージェント：main.js と、それにより直列実行される job-*.js 群のひとまとまり。

ジョブ：ある責務を持つ小さな処理単位（クラス）。例：初期データ取得、DOM 構築、イベント配線など。

エントリポイント：ジョブの順序決定と実行を担う main.js。

3. ディレクトリ別規約
3.1 js/page/**

ページ単位のエージェントを配置します。

各ページ配下は main.js と job-*.js の構成にします。

ジョブの区切りは **ページ構成（セクション/ウィジェット/インタラクション）**に即し、開発しやすい粒度で定義します。

3.2 js/service-app/**

アプリケーション横断のサービス（例：header など）をエージェントとして配置します。

main.js + job-*.js の構成とし、ページと同様に直列パイプラインを組みます。

3.3 js/service-boot/**

ブートストラップ処理（起動順序が重要な初期化処理）をエージェントとして配置します。

依存関係や初期化手順は 直列で明示し、main.js に並び順を記録します。

4. ファイル構成と責務
4.1 main.js の責務（共通）

実行順を定義した ジョブリストを保持します。

各 job-*.js のクラスを 生成 → 実行します。

エラーの 集約処理（ロギング、フェイルセーフ等）を行います。

ビジネスロジックは持ちません（ジョブに委譲）。

概念図（擬似コード）：

// main.js（概念図：実際の書き方は既存準拠ファイルに合わせる）
const jobs = [
  JobSetup,
  JobFetchData,
  JobRenderUI,
  JobBindEvents
];

(async function run() {
  for (const Job of jobs) {
    const j = new Job();
    if (typeof j.run === 'function') {
      await j.run(); // 直列実行
    }
  }
})();

4.2 job-*.js の責務（共通）

1 ファイル 1 クラス 1 責務。

外部との受け渡しは、既存準拠ファイルで採用している方式（共有オブジェクト、引数、データ属性など）に 統一します。

DOM 操作や副作用を含む場合は、ジョブ内で完結させるか、規約済みの箇所に限定します。

概念図（擬似コード）：

// job-render-header.js（概念図）
class JobRenderHeader {
  async run() {
    // DOM 作成・差し込み・最低限のイベント配線など
  }
}

5. utils/utils.js 規約（純粋関数のみ）

ESM 禁止（本体方針に同じ）。

純粋関数のみ許容：以下のいずれにも該当しないこと。

グローバル状態や外部可視の値を書き換える

DOM 操作、ネットワーク I/O、タイマー、日付の直接取得、乱数の直接取得

非決定的な振る舞い（同じ入力で常に同じ出力にならない）

関数は 引数のみを入力とし、戻り値のみで結果を返す。

UI/ビジネスロジック/状態遷移は utils に置かない。

既存準拠ファイルにない書き方・構成は置かない。

Do

// 入力に基づく変換のみ
function normalizeTitle(s) { return String(s || '').trim(); }


Don’t

// グローバル書き換え・DOM 操作・I/O・日時/乱数への直接依存などは禁止
document.title = '...';
localStorage.setItem('x', 'y');
setTimeout(...);
fetch(...);
new Date();
Math.random();

6. ジョブ分割の判断基準（開発しやすいカテゴライズ）

サービスの機能単位：例）認可、設定取得、トラッキング初期化、ヘッダー描画、フッター描画

ページ構成単位：例）メイン領域、サイドバー、モーダル

処理の境界：データ取得／整形、描画、イベント配線、後処理 など

独立性：副作用と純粋処理を分け、結合度を下げる

再利用性：他ページ・他サービスでも再利用できるまとまりを 1 ジョブ化

上記は判断材料であり、最終的には既存準拠ファイルと同様の分け方に合わせます。

7. 非同期・例外の扱い

直列実行が前提。並列化が必要な場合でも、最終的な結果整合が直列の結果と一致するようにします。

例外は main.js で 集約し、ジョブ側では必要最小限の補足に留めます。

長時間処理やリトライなどの振る舞いは、既存準拠ファイルの方式に合わせます。

【フェイルファストとフォールバック禁止（JS / PHP 全域の原則）】

新設計に関わる JavaScript / PHP 実装では、依存オブジェクトや関数、サービスが「存在することを前提とした設計」とし、
実装ミスや読み込み漏れをフォールバックで隠さない。これを JS / PHP 全域の共通規約とする。

- 依存が必須のものについて、`window.X && typeof window.X.foo === 'function'` のような
  「存在したら使う／なければ別の処理・フォールバック」のパターンは禁止する
  - 例：`if (w.Utils && typeof w.Utils.loadScriptsSync === 'function') { ... } else { this._fallbackLoad(...); }` は NG
- UI サービスやローダーなど DOM との対話を行う処理に対しても同様で、
  `if (toast && typeof toast.info === 'function') { ... }` のような
  「無ければ黙ってスキップ」や代替処理を差し込むことは禁止する
- 「存在しない＝設計バグ」とみなすべき依存については、存在しなければ例外で落ちてよい
  - 読み込み順、DI コンテナ登録漏れなどの設計の誤りを早期に露出させる

【必須依存の存在チェック禁止】

- 必須 namespace / コンストラクタに対して `if (!window.Services) { throw new Error('...'); }` のような
  「存在確認だけを行って明示的に throw する」ガードコードは書かない
  - 設計上前提としている依存が読み込まれていない場合は、プロパティ参照時の ReferenceError / TypeError で落ちて構わない
  - フォールバック目的ではなくても、単なる存在確認によるガードは冗長なので禁止する

フォールバック（代替処理）が許されるのは、以下のように**仕様として明示された段階的機能制限**のみとする。

- ブラウザの機能検出（例：`'IntersectionObserver' in window`）による「対応していない場合は機能を無効化する」
- JS を無効化している環境向けの、別 HTML / 別テンプレートによる静的な代替表示
- 外部サービス障害時に、一時的に「機能停止画面」や「後で再試行してください」を返すなど、利用者に明示的に伝わる退避

ローダー、サービス、リポジトリ、ユーティリティなど、新設計の依存関数に対し、
「本来想定していないパス」を勝手に作る `_fallback*` 系の実装は導入しない。

この方針は JS コードだけでなく、PHP 実装にも適用する。PHP でも同様に、
「必須サービスがなければ例外で落ちる」設計を基本とし、存在チェック＋サイレントフォールバックで
バグを隠さないこと。

8. 禁止事項（抜粋）

import / export、<script type="module">、require() の使用

1 ファイルに複数ジョブ（複数クラス）を同居させること

main.js にビジネスロジックを実装すること

utils/utils.js に副作用を含む処理を置くこと

規約に沿った実装を行っている既存ファイルに記載のないコードの書き方・構成の導入

9. 変更・追加の手順（運用）

追加・変更したい機能／ページの カテゴリを明確化する。

既存準拠ファイルのパターンを確認し、同一の構成・書き方で job-*.js を作成。

main.js に実行順を 明示して組み込む。

utils/utils.js が必要な場合は 純粋関数のみ で構成する。

実行順の検証（直列性の担保）と例外の集約（フェイルセーフ）を確認する。

10. 最小チェックリスト

 main.js はジョブの並びと実行のみを担っている

 各 job-*.js は 1 ファイル 1 クラス 1 責務

 直列実行で結果整合が取れている

 utils/utils.js は 純粋関数のみ、ESM 不使用

 既存準拠ファイルにない書き方・構成を導入していない

 旧設計（ドキュメントや過去コード）に引きずられていない
